# Cloudbase-Init Configuration for Terraform Integration
# This configuration is designed to work with Terraform's cloud-init provider
# for automated Windows VM provisioning in Proxmox/OpenStack environments
#
# Installation Location: C:\Program Files\Cloudbase Solutions\Cloudbase-Init\conf\cloudbase-init.conf
#
# Key Features:
# - NoCloud/ConfigDrive datasource support (Proxmox compatibility)
# - Terraform user-data and meta-data processing
# - Network configuration via cloud-init
# - SSH public key injection
# - Hostname and user management
# - Volume extension for dynamic disk sizing

[DEFAULT]
# ==============================================================================
# USER CONFIGURATION
# ==============================================================================
# FALLBACK username - ONLY used if Terraform/cloud-init doesn't specify a user
# When you pass ciuser="myuser" in Terraform, CloudBase-Init uses THAT user instead
# This is just a default if no user is specified in cloud-init metadata
username=Administrator

# User groups - applied to users created by CloudBase-Init
groups=Administrators

# CRITICAL: Inject password from cloud-init metadata
# This allows Terraform's cipassword to set/change the password
inject_user_password=true

# CRITICAL: Controls password behavior for EXISTING users
# 'no' = Always set password from cloud-init (even for existing users like Administrator)
# 'clear_text_injected_only' = Only if password is in clear text
# 'always' = Always prompt for password change on first logon
first_logon_behaviour=no

# Create user if it doesn't exist
# When Terraform passes ciuser="newuser", CloudBase-Init will CREATE that user
# When Terraform passes ciuser="Administrator", it will UPDATE the existing account
create_user=true

# NetBIOS compatibility for older network environments
netbios_host_name_compatibility=true

# ==============================================================================
# METADATA SERVICE CONFIGURATION
# ==============================================================================
# ConfigDrive settings (new syntax - avoids deprecation warnings)
[config_drive]
# Enable ConfigDrive types for Proxmox/NoCloud datasource
raw_hdd=false
cdrom=true
vfat=true
# Expected label for Proxmox cloud-init drive
types=iso
locations=cdrom

[DEFAULT]
# Specify metadata service priority
# ConfigDriveService = Proxmox/OpenStack/NoCloud (PRIMARY for Terraform)
metadata_services=cloudbaseinit.metadata.services.configdrive.ConfigDriveService,cloudbaseinit.metadata.services.httpservice.HttpService

# ==============================================================================
# TOOL PATHS
# ==============================================================================
# Path to bsdtar for archive extraction
bsdtar_path=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\bin\bsdtar.exe

# Path to mtools for FAT filesystem access
mtools_path=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\bin\

# ==============================================================================
# LOGGING CONFIGURATION
# ==============================================================================
# Enable verbose logging for troubleshooting
verbose=true
debug=true

# Log directory and file
logdir=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\log\
logfile=cloudbase-init.log

# Log levels for specific modules
default_log_levels=comtypes=INFO,suds=INFO,iso8601=WARN,requests=WARN

# Serial console logging - DISABLED (no COM port in VM)
# Uncomment if you have a serial port configured in Proxmox
# logging_serial_port_settings=COM1,115200,N,8

# ==============================================================================
# NETWORK CONFIGURATION
# ==============================================================================
# Use DHCP-provided MTU settings
mtu_use_dhcp_config=true

# Use DHCP-provided NTP server configuration
ntp_use_dhcp_config=true

# Enable NTP service for time synchronization
ntp_enable_service=true

# Set hardware clock to UTC (Linux standard)
real_time_clock_utc=true

# Keep RDP connections alive
rdp_set_keepalive=true

# ==============================================================================
# WINDOWS UPDATE CONFIGURATION
# ==============================================================================
# Disable automatic Windows updates (manage via Terraform/Ansible post-deployment)
enable_automatic_updates=false

# ==============================================================================
# PLUGIN CONFIGURATION
# ==============================================================================
# Local scripts directory for custom initialization scripts
# Terraform can upload scripts via user-data to this location
local_scripts_path=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\LocalScripts\

# Plugin execution order (CRITICAL for Terraform integration)
# This order ensures proper initialization sequence:
plugins=cloudbaseinit.plugins.common.mtu.MTUPlugin,
        cloudbaseinit.plugins.windows.ntpclient.NTPClientPlugin,
        cloudbaseinit.plugins.common.sethostname.SetHostNamePlugin,
        cloudbaseinit.plugins.windows.createuser.CreateUserPlugin,
        cloudbaseinit.plugins.common.networkconfig.NetworkConfigPlugin,
        cloudbaseinit.plugins.common.sshpublickeys.SetUserSSHPublicKeysPlugin,
        cloudbaseinit.plugins.windows.extendvolumes.ExtendVolumesPlugin,
        cloudbaseinit.plugins.common.setuserpassword.SetUserPasswordPlugin,
        cloudbaseinit.plugins.windows.winrmlistener.ConfigWinRMListenerPlugin,
        cloudbaseinit.plugins.windows.winrmcertificateauth.ConfigWinRMCertificateAuthPlugin,
        cloudbaseinit.plugins.common.userdata.UserDataPlugin,
        cloudbaseinit.plugins.common.localscripts.LocalScriptsPlugin

# Plugin Descriptions:
# 1. MTUPlugin - Configure network MTU from DHCP/metadata
# 2. NTPClientPlugin - Configure Windows Time service
# 3. SetHostNamePlugin - Set hostname from Terraform metadata
# 4. CreateUserPlugin - Create initial user from cloud-init
# 5. NetworkConfigPlugin - Apply network config from Terraform
# 6. SetUserSSHPublicKeysPlugin - Inject SSH keys for remote access
# 7. ExtendVolumesPlugin - Expand disk volumes to match Terraform resource size
# 8. SetUserPasswordPlugin - Set user password from Terraform user-data
# 9. ConfigWinRMListenerPlugin - Configure WinRM for Terraform provisioners
# 10. ConfigWinRMCertificateAuthPlugin - Enable WinRM certificate auth
# 11. UserDataPlugin - Execute Terraform user-data scripts (PowerShell/cloud-config)
# 12. LocalScriptsPlugin - Run custom scripts from LocalScripts directory

# ==============================================================================
# BEHAVIOR CONFIGURATION
# ==============================================================================
# Allow automatic reboot if required by plugins
allow_reboot=true

# Keep service running after initialization (for ongoing cloud-init support)
stop_service_on_exit=false

# Disable version checking (avoid external connections during provisioning)
check_latest_version=false

# ==============================================================================
# TERRAFORM INTEGRATION NOTES
# ==============================================================================
#
# 1. USER-DATA FORMAT:
#    Terraform cloud-init provider supports both:
#    - PowerShell scripts (#ps1)
#    - cloud-config YAML format (#cloud-config)
#
#    Example Terraform configuration:
#    ```hcl
#    data "cloudinit_config" "windows" {
#      gzip          = false
#      base64_encode = false
#
#      part {
#        content_type = "text/cloud-config"
#        content      = <<-EOT
#          #cloud-config
#          hostname: ${var.hostname}
#          users:
#            - name: terraform
#              gecos: Terraform User
#              groups: Administrators
#              passwd: ${random_password.terraform_user.result}
#              ssh_authorized_keys:
#                - ${file("~/.ssh/id_rsa.pub")}
#        EOT
#      }
#
#      part {
#        content_type = "text/x-shellscript"
#        content      = file("${path.module}/scripts/bootstrap.ps1")
#      }
#    }
#
#    resource "proxmox_vm_qemu" "windows" {
#      cicustom = "user=local:snippets/windows-user-data.yaml"
#      # ... other configuration
#    }
#    ```
#
# 2. META-DATA:
#    Provides instance-specific information:
#    - instance-id
#    - local-hostname
#    - public-keys
#    - network-interfaces
#
# 3. NETWORK-CONFIG:
#    Optional network configuration in Netplan/cloud-init format
#    Useful for static IP configuration
#
# 4. VENDOR-DATA:
#    Additional configuration data from infrastructure provider
#
# ==============================================================================

# ==============================================================================
# WINRM CONFIGURATION FOR TERRAFORM PROVISIONERS
# ==============================================================================
# WinRM is required for Terraform's winrm provisioner
# These settings are applied by ConfigWinRMListenerPlugin

# Enable basic authentication (use with caution, only over HTTPS in production)
winrm_enable_basic_auth=true

# HTTPS listener configuration (recommended for production)
# Cloudbase-Init will generate a self-signed certificate
winrm_configure_https_listener=true

# HTTP listener (disable in production, useful for testing)
winrm_configure_http_listener=false

# ==============================================================================
# TROUBLESHOOTING
# ==============================================================================
# If Cloudbase-Init doesn't execute:
# 1. Check logs: C:\Program Files\Cloudbase Solutions\Cloudbase-Init\log\
# 2. Verify cloud-init drive is attached (should appear as CD-ROM)
# 3. Check Windows Event Viewer: Application and System logs
# 4. Ensure metadata service is reachable
# 5. Validate user-data YAML/PowerShell syntax
#
# Common issues:
# - ConfigDrive not detected: Check Proxmox cloud-init CD-ROM attachment
# - Scripts not executing: Verify PowerShell execution policy
# - Network config not applied: Check NetworkConfigPlugin in logs
# - Hostname not set: Ensure meta-data contains 'local-hostname'
#
# Manual re-run (for testing):
# C:\Program Files\Cloudbase Solutions\Cloudbase-Init\bin\cloudbase-init.exe --config-file cloudbase-init.conf
# ==============================================================================
