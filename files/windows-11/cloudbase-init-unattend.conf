# Cloudbase-Init Unattend Configuration
# This configuration runs DURING Windows setup (before first user logon)
# for specialized bootstrapping tasks
#
# Installation Location: C:\Program Files\Cloudbase Solutions\Cloudbase-Init\conf\cloudbase-init-unattend.conf
#
# Key Differences from cloudbase-init.conf:
# - Runs in SYSTEM context during Windows setup
# - Limited plugin set (only setup-compatible plugins)
# - Executes before user login
# - Prepares system for final cloudbase-init.conf execution

[DEFAULT]
# ==============================================================================
# USER CONFIGURATION (Unattend Phase)
# ==============================================================================
# Use ansible user (created during Windows installation via AutoUnattend.xml)
username=ansible
groups=Administrators
inject_user_password=true

# ==============================================================================
# METADATA SERVICE CONFIGURATION
# ==============================================================================
# Same as main config - prioritize ConfigDrive for Proxmox/Terraform
config_drive_raw_hhd=true
config_drive_cdrom=true
config_drive_vfat=true

metadata_services=cloudbaseinit.metadata.services.configdrive.ConfigDriveService,cloudbaseinit.metadata.services.httpservice.HttpService,cloudbaseinit.metadata.services.ec2service.EC2Service,cloudbaseinit.metadata.services.maasservice.MaaSHttpService

# ==============================================================================
# TOOL PATHS
# ==============================================================================
bsdtar_path=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\bin\bsdtar.exe
mtools_path=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\bin\

# ==============================================================================
# LOGGING CONFIGURATION
# ==============================================================================
verbose=true
debug=true
logdir=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\log\
logfile=cloudbase-init-unattend.log
default_log_levels=comtypes=INFO,suds=INFO,iso8601=WARN,requests=WARN
logging_serial_port_settings=COM1,115200,N,8

# ==============================================================================
# NETWORK CONFIGURATION
# ==============================================================================
mtu_use_dhcp_config=true
ntp_use_dhcp_config=true

# ==============================================================================
# LOCAL SCRIPTS
# ==============================================================================
local_scripts_path=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\LocalScripts\

# ==============================================================================
# UNATTEND-SPECIFIC PLUGINS
# ==============================================================================
# CRITICAL: Only use plugins compatible with Windows setup phase
# These plugins run BEFORE user logon, so they have limited functionality
#
# Recommended minimal plugin set for unattend phase:
plugins=cloudbaseinit.plugins.common.mtu.MTUPlugin,
        cloudbaseinit.plugins.common.sethostname.SetHostNamePlugin,
        cloudbaseinit.plugins.windows.extendvolumes.ExtendVolumesPlugin

# Plugin rationale:
# 1. MTUPlugin - Configure network MTU early
# 2. SetHostNamePlugin - Set hostname during setup (requires reboot)
# 3. ExtendVolumesPlugin - Expand volumes to match disk size immediately
#
# EXCLUDED from unattend (run in main cloudbase-init.conf instead):
# - CreateUserPlugin (conflicts with Administrator account)
# - NetworkConfigPlugin (better after first boot)
# - SetUserSSHPublicKeysPlugin (requires user account)
# - SetUserPasswordPlugin (handled by main config)
# - WinRM plugins (configured after first boot)
# - UserDataPlugin (executes after full boot)
# - LocalScriptsPlugin (run in main config)

# ==============================================================================
# BEHAVIOR CONFIGURATION
# ==============================================================================
# Allow reboot after unattend phase (required for hostname change)
allow_reboot=true

# Stop service after unattend phase (main service will start after first boot)
stop_service_on_exit=true

# Disable version checking
check_latest_version=false

# ==============================================================================
# TERRAFORM INTEGRATION NOTES
# ==============================================================================
#
# UNATTEND PHASE EXECUTION FLOW:
# 1. Windows installation completes
# 2. cloudbase-init-unattend runs (this config)
#    - Sets hostname from meta-data
#    - Extends disk volumes
#    - Configures MTU
# 3. System reboots (if hostname changed)
# 4. Windows first boot / OOBE
# 5. cloudbase-init runs (main config)
#    - Creates users
#    - Configures network
#    - Injects SSH keys
#    - Configures WinRM
#    - Executes user-data scripts
# 6. Terraform provisioners can connect via WinRM
#
# This two-phase approach ensures:
# - System-level changes (hostname, disk) happen early
# - User-level configuration happens after OOBE
# - WinRM is available for Terraform provisioners
#
# ==============================================================================

# ==============================================================================
# TROUBLESHOOTING UNATTEND PHASE
# ==============================================================================
# Check logs at:
# C:\Program Files\Cloudbase Solutions\Cloudbase-Init\log\cloudbase-init-unattend.log
#
# Common issues:
# - Service doesn't run: Check Windows Event Viewer for service errors
# - Hostname not set: Verify meta-data contains 'local-hostname'
# - Disk not extended: Check if ExtendVolumesPlugin is in plugin list
# - Multiple reboots: Hostname change triggers reboot by design
#
# Manual execution (for testing):
# C:\Program Files\Cloudbase Solutions\Cloudbase-Init\bin\cloudbase-init.exe --config-file cloudbase-init-unattend.conf
# ==============================================================================
