# Cloudbase-Init Unattend Configuration
# This configuration runs DURING Windows setup (before first user logon)
# for specialized bootstrapping tasks
#
# Installation Location: C:\Program Files\Cloudbase Solutions\Cloudbase-Init\conf\cloudbase-init-unattend.conf
#
# Key Differences from cloudbase-init.conf:
# - Runs in SYSTEM context during Windows setup
# - Limited plugin set (only setup-compatible plugins)
# - Executes before user login
# - Prepares system for final cloudbase-init.conf execution
# - Handles disk, boot config, and hostname changes that require reboot

[DEFAULT]
# ==============================================================================
# USER CONFIGURATION (Unattend Phase)
# ==============================================================================
# Fallback username - Terraform's ciuser overrides this
username=Administrator
groups=Administrators
inject_user_password=true
create_user=true
first_logon_behaviour=no

# ==============================================================================
# METADATA SERVICE CONFIGURATION
# ==============================================================================
[config_drive]
raw_hdd=false
cdrom=true
vfat=true
types=iso
locations=cdrom

[DEFAULT]
metadata_services=cloudbaseinit.metadata.services.configdrive.ConfigDriveService,cloudbaseinit.metadata.services.httpservice.HttpService

# ==============================================================================
# TOOL PATHS
# ==============================================================================
bsdtar_path=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\bin\bsdtar.exe
mtools_path=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\bin\

# ==============================================================================
# LOGGING CONFIGURATION
# ==============================================================================
verbose=true
debug=true
logdir=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\log\
logfile=cloudbase-init-unattend.log
default_log_levels=comtypes=INFO,suds=INFO,iso8601=WARN,requests=WARN
# Serial port disabled - no COM port in VM
# logging_serial_port_settings=COM1,115200,N,8

# ==============================================================================
# NETWORK CONFIGURATION
# ==============================================================================
mtu_use_dhcp_config=true
ntp_use_dhcp_config=true

# ==============================================================================
# DISK AND STORAGE CONFIGURATION (Unattend Phase)
# ==============================================================================
# Enable TRIM for SSD optimization during early boot
trim_enabled=true

# SAN Policy - bring all disks online automatically
san_policy=OnlineAll

# Set unique boot disk ID to avoid collisions when cloning
set_unique_boot_disk_id=true

# BCD settings for reliable boot
bcd_enable_auto_recovery=true
bcd_boot_status_policy=ignoreallfailures

# ==============================================================================
# LOCAL SCRIPTS
# ==============================================================================
local_scripts_path=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\LocalScripts\

# ==============================================================================
# UNATTEND-SPECIFIC PLUGINS
# ==============================================================================
# CRITICAL: Only use plugins compatible with Windows setup phase
# These plugins run BEFORE user logon, so they have limited functionality
#
# Unattend phase plugins handle:
# - System-level disk operations (TRIM, SAN policy, BCD config)
# - Hostname setting (requires reboot)
# - Volume extension
# - Boot configuration
#
plugins=cloudbaseinit.plugins.common.mtu.MTUPlugin,
        cloudbaseinit.plugins.common.sethostname.SetHostNamePlugin,
        cloudbaseinit.plugins.windows.extendvolumes.ExtendVolumesPlugin,
        cloudbaseinit.plugins.common.trim.TrimConfigPlugin,
        cloudbaseinit.plugins.windows.sanpolicy.SANPolicyPlugin,
        cloudbaseinit.plugins.windows.bootconfig.BootStatusPolicyPlugin,
        cloudbaseinit.plugins.windows.bootconfig.BCDConfigPlugin

# Plugin rationale for unattend phase:
# 1. MTUPlugin - Configure network MTU early
# 2. SetHostNamePlugin - Set hostname during setup (requires reboot)
# 3. ExtendVolumesPlugin - Expand volumes to match disk size immediately
# 4. TrimConfigPlugin - Enable TRIM for SSD optimization
# 5. SANPolicyPlugin - Configure SAN policy for disk handling
# 6. BootStatusPolicyPlugin - Configure boot failure handling
# 7. BCDConfigPlugin - Set unique boot disk ID, enable auto-recovery
#
# EXCLUDED from unattend (run in main cloudbase-init.conf instead):
# - CreateUserPlugin (conflicts with Administrator account during setup)
# - NetworkConfigPlugin (better after first boot when network is stable)
# - SetUserSSHPublicKeysPlugin (requires user account to exist)
# - SetUserPasswordPlugin (handled by main config)
# - WindowsLicensingPlugin (better after OOBE)
# - WinRM plugins (configured after first boot)
# - RDPSettingsPlugin (better after OOBE)
# - UserDataPlugin (executes after full boot)
# - LocalScriptsPlugin (run in main config)

# ==============================================================================
# BEHAVIOR CONFIGURATION
# ==============================================================================
# Allow reboot after unattend phase (required for hostname change)
allow_reboot=true

# Stop service after unattend phase (main service will start after first boot)
stop_service_on_exit=true

# Disable version checking
check_latest_version=false

# ==============================================================================
# TROUBLESHOOTING UNATTEND PHASE
# ==============================================================================
# Check logs at:
# C:\Program Files\Cloudbase Solutions\Cloudbase-Init\log\cloudbase-init-unattend.log
#
# Common issues:
# - Service doesn't run: Check Windows Event Viewer for service errors
# - Hostname not set: Verify meta-data contains 'local-hostname'
# - Disk not extended: Check if ExtendVolumesPlugin is in plugin list
# - Multiple reboots: Hostname change triggers reboot by design
#
# Manual execution (for testing):
# C:\Program Files\Cloudbase Solutions\Cloudbase-Init\bin\cloudbase-init.exe --config-file cloudbase-init-unattend.conf
# ==============================================================================
