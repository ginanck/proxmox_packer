# Cloudbase-Init Configuration for Terraform Integration
# This configuration is designed to work with Terraform's cloud-init provider
# for automated Windows VM provisioning in Proxmox/OpenStack environments
#
# Installation Location: C:\Program Files\Cloudbase Solutions\Cloudbase-Init\conf\cloudbase-init.conf
#
# Key Features:
# - NoCloud/ConfigDrive datasource support (Proxmox compatibility)
# - Terraform user-data and meta-data processing
# - Network configuration via cloud-init
# - SSH public key injection (OpenSSH Server support)
# - Hostname and user management
# - Volume extension for dynamic disk sizing
# - Windows licensing management (trial/evaluation mode)
# - Timezone and locale configuration
# - RDP and SSH remote access configuration
# - TRIM support for SSD optimization
# - SAN policy configuration for disk management

[DEFAULT]
# ==============================================================================
# USER CONFIGURATION
# ==============================================================================
# FALLBACK username - ONLY used if Terraform/cloud-init doesn't specify a user
# When you pass ciuser="myuser" in Terraform, CloudBase-Init uses THAT user instead
# This is just a default if no user is specified in cloud-init metadata
username=Administrator

# User groups - applied to users created by CloudBase-Init
groups=Administrators

# CRITICAL: Inject password from cloud-init metadata
# This allows Terraform's cipassword to set/change the password
inject_user_password=true

# CRITICAL: Controls password behavior for EXISTING users
# 'no' = Always set password from cloud-init (even for existing users like Administrator)
# 'clear_text_injected_only' = Only if password is in clear text
# 'always' = Always prompt for password change on first logon
# NOTE: 'always' prevented the Administrator password from being set during deployment in some cases (Windows Server 2016).
#       Set to 'no' to ensure Terraform-provided init password is applied to existing accounts (Administrator).
first_logon_behaviour=no

# Create user if it doesn't exist
# When Terraform passes ciuser="newuser", CloudBase-Init will CREATE that user
# When Terraform passes ciuser="Administrator", it will UPDATE the existing account
create_user=true

# NetBIOS compatibility for older network environments
netbios_host_name_compatibility=true

# ==============================================================================
# METADATA SERVICE CONFIGURATION
# ==============================================================================
# ConfigDrive settings (new syntax - avoids deprecation warnings)
[config_drive]
# Enable ConfigDrive types for Proxmox/NoCloud datasource
raw_hdd=false
cdrom=true
vfat=true
# Expected label for Proxmox cloud-init drive
types=iso
locations=cdrom

[DEFAULT]
metadata_services=cloudbaseinit.metadata.services.configdrive.ConfigDriveService

# ==============================================================================
# TOOL PATHS
# ==============================================================================
# Path to bsdtar for archive extraction
bsdtar_path=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\bin\bsdtar.exe

# Path to mtools for FAT filesystem access
mtools_path=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\bin\

# ==============================================================================
# LOGGING CONFIGURATION
# ==============================================================================
# Enable verbose logging for troubleshooting
verbose=true
debug=true

# Log directory and file
logdir=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\log\
logfile=cloudbase-init.log

# Log levels for specific modules
default_log_levels=comtypes=INFO,suds=INFO,iso8601=WARN,requests=WARN

# Serial console logging - DISABLED (no COM port in VM)
# Uncomment if you have a serial port configured in Proxmox
# logging_serial_port_settings=COM1,115200,N,8

# ==============================================================================
# NETWORK CONFIGURATION
# ==============================================================================
# Use DHCP-provided MTU settings
mtu_use_dhcp_config=true

# Use DHCP-provided NTP server configuration
ntp_use_dhcp_config=true

# Enable NTP service for time synchronization
ntp_enable_service=true

# Set hardware clock to UTC (Linux standard)
real_time_clock_utc=true

# Keep RDP connections alive (used by RDPSettingsPlugin)
rdp_set_keepalive=true

# ==============================================================================
# WINDOWS UPDATE CONFIGURATION
# ==============================================================================
# Disable automatic Windows updates (manage via Terraform/Ansible post-deployment)
enable_automatic_updates=false

# ==============================================================================
# WINDOWS LICENSING CONFIGURATION (Lab Environment)
# ==============================================================================
# For lab/trial environments, we don't activate Windows
# Set activate_windows=true and configure KMS for production environments
activate_windows=false

# Don't set KMS product key (use trial/evaluation license)
set_kms_product_key=false

# Don't set AVMA product key
set_avma_product_key=false

# Log licensing information for troubleshooting
log_licensing_info=true

# KMS host (uncomment and set for production environments)
# kms_host=kms.example.com:1688

# ==============================================================================
# DISK AND STORAGE CONFIGURATION
# ==============================================================================
# Enable TRIM for SSD optimization
# Sends TRIM/UNMAP commands to underlying storage for better SSD performance
trim_enabled=true

# SAN Policy - how to handle new disks
# OnlineAll: Bring all disks online automatically
# OfflineAll: Keep all disks offline until manually configured
# OfflineShared: Keep shared disks offline (for clustering)
san_policy=OnlineAll

# Boot disk configuration - set unique disk ID to avoid collisions
set_unique_boot_disk_id=true

# BCD (Boot Configuration Data) settings
# Enable auto-recovery for boot issues
bcd_enable_auto_recovery=true

# Boot status policy - ignore boot failures (useful for cloud VMs)
bcd_boot_status_policy=ignoreallfailures

# Volumes to extend - extend all volumes by default
# Uncomment to specify specific volumes: volumes_to_extend=1,2
# volumes_to_extend=

# ==============================================================================
# DISPLAY AND POWER CONFIGURATION
# ==============================================================================
# Display idle timeout (0 = always on, useful for servers/VMs)
display_idle_timeout=0

# ==============================================================================
# PLUGIN CONFIGURATION
# ==============================================================================
# Local scripts directory for custom initialization scripts
# Terraform can upload scripts via user-data to this location
local_scripts_path=C:\Program Files\Cloudbase Solutions\Cloudbase-Init\LocalScripts\

# Plugin execution order (CRITICAL for Terraform integration)
# This order ensures proper initialization sequence:
#
# PRE_METADATA_DISCOVERY stage plugins (run first):
#   MTUPlugin - Configure network MTU before metadata discovery
#
# PRE_NETWORKING stage plugins:
#   NTPClientPlugin - Configure time synchronization early
#
# MAIN stage plugins (run in order after networking is available):
# NOTE: WinRM plugins removed - WinRM HTTP/Basic auth is configured during Packer build
#       and preserved after Sysprep. Cloudbase-Init WinRM plugins would override with HTTPS.
plugins=cloudbaseinit.plugins.common.mtu.MTUPlugin,
        cloudbaseinit.plugins.windows.ntpclient.NTPClientPlugin,
        cloudbaseinit.plugins.common.sethostname.SetHostNamePlugin,
        cloudbaseinit.plugins.common.userdata.UserDataPlugin,
        cloudbaseinit.plugins.windows.createuser.CreateUserPlugin,
        cloudbaseinit.plugins.common.setuserpassword.SetUserPasswordPlugin,
        cloudbaseinit.plugins.common.sshpublickeys.SetUserSSHPublicKeysPlugin,
        cloudbaseinit.plugins.windows.extendvolumes.ExtendVolumesPlugin,
        cloudbaseinit.plugins.common.networkconfig.NetworkConfigPlugin,
        cloudbaseinit.plugins.windows.licensing.WindowsLicensingPlugin,
        cloudbaseinit.plugins.common.trim.TrimConfigPlugin,
        cloudbaseinit.plugins.windows.sanpolicy.SANPolicyPlugin,
        cloudbaseinit.plugins.windows.rdp.RDPSettingsPlugin,
        cloudbaseinit.plugins.windows.bootconfig.BootStatusPolicyPlugin,
        cloudbaseinit.plugins.windows.bootconfig.BCDConfigPlugin,
        cloudbaseinit.plugins.windows.displayidletimeout.DisplayIdleTimeoutConfigPlugin,
        cloudbaseinit.plugins.windows.updates.WindowsAutoUpdatesPlugin,
        cloudbaseinit.plugins.common.localscripts.LocalScriptsPlugin

# ==============================================================================
# PLUGIN DESCRIPTIONS
# ==============================================================================
# 1.  MTUPlugin - Configure network MTU from DHCP/metadata (PRE_METADATA_DISCOVERY)
# 2.  NTPClientPlugin - Configure Windows Time service (PRE_NETWORKING)
# 3.  SetHostNamePlugin - Set hostname from Terraform metadata
# 4.  UserDataPlugin - Execute Terraform user-data scripts (PowerShell/cloud-config)
# 5.  CreateUserPlugin - Create initial user from cloud-init
# 6.  SetUserPasswordPlugin - Set user password from Terraform user-data
# 7.  SetUserSSHPublicKeysPlugin - Inject SSH keys for OpenSSH access
# 8.  ExtendVolumesPlugin - Expand disk volumes to match Terraform resource size
# 9.  NetworkConfigPlugin - Apply network config from Terraform
# 10. WindowsLicensingPlugin - Handle Windows licensing (trial mode for lab)
# 11. TrimConfigPlugin - Enable TRIM for SSD optimization
# 12. SANPolicyPlugin - Configure SAN policy for disk management
# 13. RDPSettingsPlugin - Configure RDP keepalive settings
# 14. BootStatusPolicyPlugin - Configure boot status policy
# 15. BCDConfigPlugin - Configure BCD boot settings
# 16. DisplayIdleTimeoutConfigPlugin - Configure display idle timeout
# 17. WindowsAutoUpdatesPlugin - Control Windows Update behavior
# 18. LocalScriptsPlugin - Execute scripts from LocalScripts directory
#
# REMOVED PLUGINS (WinRM configured during Packer build instead):
# - ConfigWinRMListenerPlugin - Would override HTTP listener with HTTPS
# - ConfigWinRMCertificateAuthPlugin - Certificate auth not needed for Terraform
# 20. LocalScriptsPlugin - Run custom scripts from LocalScripts directory

# ==============================================================================
# BEHAVIOR CONFIGURATION
# ==============================================================================
# Allow automatic reboot if required by plugins
allow_reboot=true

# Keep service running after initialization (for ongoing cloud-init support)
stop_service_on_exit=false

# Disable version checking (avoid external connections during provisioning)
check_latest_version=false


# ==============================================================================
# WINRM CONFIGURATION FOR TERRAFORM PROVISIONERS
# ==============================================================================
# WinRM is required for Terraform's winrm provisioner
# These settings are applied by ConfigWinRMListenerPlugin

# Enable basic authentication (use with caution, only over HTTPS in production)
winrm_enable_basic_auth=true

# HTTPS listener configuration (recommended for production)
# Cloudbase-Init will generate a self-signed certificate
winrm_configure_https_listener=true

# HTTP listener (disable in production, useful for testing)
winrm_configure_http_listener=false

# ==============================================================================
# TROUBLESHOOTING
# ==============================================================================
# If Cloudbase-Init doesn't execute:
# 1. Check logs: C:\Program Files\Cloudbase Solutions\Cloudbase-Init\log\
# 2. Verify cloud-init drive is attached (should appear as CD-ROM)
# 3. Check Windows Event Viewer: Application and System logs
# 4. Ensure metadata service is reachable
# 5. Validate user-data YAML/PowerShell syntax
#
# Common issues:
# - ConfigDrive not detected: Check Proxmox cloud-init CD-ROM attachment
# - Scripts not executing: Verify PowerShell execution policy
# - Network config not applied: Check NetworkConfigPlugin in logs
# - Hostname not set: Ensure meta-data contains 'local-hostname'
# - SSH keys not working: Verify OpenSSH Server is installed and running
# - Licensing issues: Check WindowsLicensingPlugin logs (trial mode is normal)
#
# Manual re-run (for testing):
# C:\Program Files\Cloudbase Solutions\Cloudbase-Init\bin\cloudbase-init.exe --config-file cloudbase-init.conf
#
# ==============================================================================
# INSTALLED TOOLS AND SERVICES
# ==============================================================================
# This template includes the following tools (installed during Packer build):
#
# 1. Python 3.12+ with pip
#    - Location: C:\Python312\
#    - Includes pywinrm for Ansible support
#
# 2. Git for Windows
#    - Location: C:\Program Files\Git\
#    - Includes Git Bash for Unix-like shell
#
# 3. OpenSSH Server
#    - Port: 22
#    - Supports SSH key authentication via cloud-init
#    - Alternative to WinRM for Ansible
#
# 4. VirtIO Guest Tools (QEMU Guest Agent)
#    - Enables Proxmox VM management features
#    - Graceful shutdown, backup freeze/thaw
#
# 5. curl.exe (built-in to Windows 11)
#    - Available in PATH for scripting
#
# ==============================================================================
